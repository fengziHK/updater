!function(){"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("node-fetch")),r=e(require("@octokit/rest")),a=e(require("@octokit/plugin-retry")),i=e(require("crypto"));const s=e=>!!e.success,o=async e=>{const r=(await t("https://lihkg.com/",{headers:{Host:"lihkg.com",Referer:"https://lihkg.com/","User-Agent":e,Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Language":"en-US","Accept-Encoding":"gzip, deflate, br"}})).headers.raw()["set-cookie"];return Object.fromEntries(r.map(e=>{const t=e.match(/^(\w+)=(.+?);/);return[t[1],t[2]]}))},n=async e=>Object.entries(await e).map(([e,t])=>`${e}=${t}`).join("; ");class c{static async getCookies(){if(this.cookies&&this.cookieUses<=500)return this.cookieUses++,this.cookies;this.cookieUses=0;const e=await n(o(this.userAgent));return this.cookies=e,e}static async fetchAPIResponse(e){const r=await t(e,{headers:{Referer:"https://lihkg.com/","User-Agent":this.userAgent,Cookie:await this.getCookies()}});if(!r.ok)throw console.error(await r.text()),new Error(`${e} ${r.status} ${r.statusText}`);const a=await r.json();if(!s(a))throw new Error(`${e} ${a.error_code} ${a.error_message}`);return a}static async fetchThreadDetail(e,t=1,r="reply_time"){const a=`${this.ENDPOINT}/thread/${e}/page/${t}?order=${r}`;return(await this.fetchAPIResponse(a)).response}static async fetchFullThread(e){const t=await this.fetchThreadDetail(e,1),{total_page:r,item_data:a}=t;return a.push(...(await Promise.all(Array.from({length:r-2}).map(async(t,r)=>{return(await this.fetchThreadDetail(e,r+2)).item_data}))).flat()),t.page=void 0,t}static async fetchUser(e){const t=`${this.ENDPOINT}/user/${e}/profile`;return(await this.fetchAPIResponse(t)).response.user}static async fetchLatestThreads(e=1,t=1){const r=`${this.ENDPOINT}/thread/latest?cat_id=${t}&page=${e}&count=60&type=now`;return(await this.fetchAPIResponse(r)).response}}c.ENDPOINT="https://lihkg.com/api_v2",c.userAgent="Mozilla/5.0 Gecko/20100101 Firefox/71.0",c.cookieUses=0;const l=c.fetchFullThread.bind(c);c.fetchUser.bind(c);class h{static formatTime(e){return new Date(1e3*e)}static formatReply(e){return{pid:e.post_id,tid:+e.thread_id,uid:+e.user.user_id,like:+e.like_count,dislike:+e.dislike_count,score:+e.vote_score,quote:e.quote&&this.formatReply(e.quote),citedBy:+e.no_of_quote,replyTime:this.formatTime(e.reply_time),msg:e.msg}}static formatThread(e){return{tid:+e.thread_id,cid:+e.cat_id,subCid:+e.sub_cat_id,title:e.title,createTime:this.formatTime(e.create_time),uid:+e.user_id,like:+e.like_count,dislike:+e.dislike_count,uniUserReply:+e.no_of_uni_user_reply}}static formatThreadDetail(e){return{...this.formatThread(e),replies:e.item_data.map(e=>this.formatReply(e))}}static formatThreadInfo(e){return{...this.formatThread(e),lastReplyTime:this.formatTime(e.last_reply_time),lastReplyUid:+e.last_reply_user_id}}static formatThreadMinInfo(e){return{tid:+e.thread_id,cid:+e.cat_id,uid:+e.user_id,title:e.title,score:+e.like_count-+e.dislike_count,replied:e.last_reply_time,pages:+e.total_page}}static formatUserInfo(e){return{uid:+e.user_id,name:e.nickname,gender:e.gender,level:+e.level,levelName:e.level_name,createTime:this.formatTime(e.create_time)}}}const u=process.env.AUTH_TOKEN;if(!u)throw new Error("AUTH_TOKEN is undefined");const d=new(r.plugin(a))({auth:u}),m=e=>{return`${e.toString().slice(-1)[0]}/${e}.json`},f=async(e,t)=>{const r=Buffer.from(t,"utf-8"),a=r.toString("base64"),s=await(async e=>{try{const{data:t}=await d.repos.getContents({owner:"lihkg-backup",repo:"thread",path:m(e)});if(Array.isArray(t))throw new Error("file should not be a directory");return t.sha}catch(e){}})(e);if(s){const e=`blob ${r.byteLength}\0`;if((e=>{const t=i.createHash("sha1");return t.update(e),t.digest("hex")})(Buffer.concat([Buffer.from(e),r]))===s)return}return d.repos.createOrUpdateFile({owner:"lihkg-backup",repo:"thread",path:m(e),message:`update ${e}.json ${(new Date).toISOString()}`,content:a,branch:"master",sha:s,committer:{email:"lihkg@github.com",name:"lihkg"}})},p=async e=>{const t=await l(e),r=h.formatThreadDetail(t),a=JSON.stringify(r);await f(e,a)};(async(e=1)=>{const t=await(async(e=15)=>{const t=new Set,r=t=>+new Date-+t>6e4*e;for(let e=1;;e++)try{const{items:a}=await c.fetchLatestThreads(e),i=a.map(e=>[+e.thread_id,h.formatTime(e.last_reply_time)]);if(i.forEach(([e,a])=>{r(a)||t.add(e)}),i.some(([,e])=>r(e)))break}catch(e){console.error(e);break}return[...t]})(),r=t.length;console.log(r,t);let a=[],i=0;for(let s=0;s<r;s++){const o=t[s];a.push(async()=>{console.log(`update ${o}.json ${s+1}/${r}`);try{await p(o),i++}catch(e){console.error(e)}}),a.length>=e&&(await Promise.all(a.map(e=>e())),a=[])}await Promise.all(a.map(e=>e())),console.log(`${i}/${r} success`)})()}();
